<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">

<head>
</head>

<body>

<form th:object="${createReservationForm}" method="post" th:fragment="">

    <table class="formtable">

        <!-- First name -->
        <tr>
            <td colspan="2">
                <input type="text" class="form-control" placeholder="First name" th:field="*{customerFirstname}"/>
                <div th:if="${#fields.hasErrors('customerFirstname')}" th:errors="*{customerFirstname}">
                    First name error
                </div>
            </td>
        </tr>

        <!-- Last name -->
        <tr>
            <td colspan="2">
                <input type="text" class="form-control" placeholder="Last name" th:field="*{customerLastname}"/>
                <div th:if="${#fields.hasErrors('customerLastname')}" th:errors="*{customerLastname}">Last name error
                </div>
            </td>
        </tr>

        <!-- Phone number -->
        <tr>
            <td colspan="2">
                <input type="text" class="form-control" placeholder="Phone number" th:field="*{customerPhonenumber}"/>
                <div th:if="${#fields.hasErrors('customerPhonenumber')}" th:errors="*{customerPhonenumber}">Phone number
                    error
                </div>
            </td>
        </tr>

        <!-- Places -->
        <tr>
            <td colspan="2">
                <input type="text" class="form-control" placeholder="Number of places" th:field="*{places}"
                       id="places"/>
                <div th:if="${#fields.hasErrors('places')}" th:errors="*{places}">
                    Places errors
                </div>
            </td>
        </tr>

        <!-- Dates arrival / departure-->

        <tr>
            <td>
                <input type="text" th:field="*{begin}" class="form-control" id="beginDate" placeholder="Arrival"
                       readonly="readonly"/>
            </td>
            <td>
                <input type="text" th:field="*{end}" class="form-control" id="endDate" placeholder="Departure"
                       readonly="readonly"/>
            </td>
        </tr>

        <!-- Resources-->

        <tr>
            <td>
                Room:
            </td>
            <td>
                <select id="sharedResourceIdSelect" class="form-control" th:field="*{sharedResourceId}">
                    <option th:each="resource : ${sharedResources}"
                            th:value="${resource.getId()}"
                            th:text="${resource.getName()}">Resource name
                    </option>
                </select>
            </td>

        </tr>

        <tr>
            <td colspan="2">
                <div th:if="${#fields.hasErrors('sharedResourceId')}" th:errors="*{sharedResourceId}">
                    Shared resource error
                </div>
                <div th:if="${#fields.hasErrors('begin')}" th:errors="*{begin}">Arrival error</div>
                <div th:if="${#fields.hasErrors('end')}" th:errors="*{end}">Departure error</div>
                <div th:if="${#fields.hasErrors('token')}" th:text="'Please update form and try again'">Token error
                </div>
                <div th:if="${errorMessage == null || errorMessage.isEmpty() == false}" th:text="${errorMessage}">Error
                    message
                </div>
            </td>
        </tr>

        <!-- Token and submit button -->

        <tr>
            <td colspan="2">

                <!-- Add control token -->
                <input type="hidden" name="token" th:value="${token}"/>

                <button type="submit" class="btn btn-primary">Make a reservation</button>
            </td>
        </tr>

    </table>

    <script th:inline="javascript">
        $(function () {

            var beginDate = $("#beginDate");
            var endDate = $("#endDate");
            var roomSelect = $("#sharedResourceIdSelect");
            var placesTxt = $("#places");

            var defaultColor = $(beginDate).css('background');
            var errorColor = "rgb(255, 191, 191)";

            var setDateFieldBackground = function (error) {
                endDate.css('background', error ? errorColor : defaultColor);
                beginDate.css('background', error ? errorColor : defaultColor);
            };

            var checkDates = function () {

                var bd = moment(beginDate.val(), "DD/MM/YYYY");
                var ed = moment(endDate.val(), "DD/MM/YYYY");

                // check if dates are in order
                if (bd._isValid == false || ed._isValid == false || bd.isAfter(ed)) {
                    setDateFieldBackground(true);
                    throw "Dates are invalid"
                }

            };

            var checkAvailability = function () {
                var arrival = beginDate.val();
                var departure = endDate.val();
                var places = placesTxt.val();

                roomSelect.empty();

                ReservationUtils.getRoomsAvailable(arrival, departure, places)
                        .then(function (result) {

                            $.each(result, function (index, element) {

                                var elmt = $("<option/>");
                                elmt.text(element.name);
                                elmt.attr("value", element.id);

                                roomSelect.append(elmt);
                            });

                            if (!result || result.length == 0) {
                                roomSelect.append("<option>No room available</option>");
                            }

                        })
                        .fail(function () {
                            console.error("Fail !");
                            roomSelect.append("<option>Error</option>");
                        });
            };

            // transform fields in date picker
            beginDate.datepicker({
                dateFormat: "dd/mm/yy",
                onSelect: function () {
                    setDateFieldBackground(false);
                    checkDates();
                    checkAvailability();
                }
            });

            endDate.datepicker({
                dateFormat: "dd/mm/yy",
                onSelect: function () {
                    setDateFieldBackground(false);
                    checkDates();
                    checkAvailability();
                }
            });

            placesTxt.on('input', function () {
                checkAvailability();
            });

            // first check
            checkAvailability();

        });
    </script>

</form>
</body>
</html>